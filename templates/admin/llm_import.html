{% extends "admin/base.html" %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">LLM Article Import</h1>
        <p class="mt-2 text-gray-600">Import and process articles generated by AI language models</p>
    </div>

    <!-- Import Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <form id="llm-import-form" class="space-y-6">
                <!-- Content Input -->
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700">
                        Article Content
                    </label>
                    <div class="mt-1">
                        <textarea id="content" name="content" rows="12" 
                                  class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mt-1 block w-full sm:text-sm border-gray-300 rounded-md"
                                  placeholder="Paste your LLM-generated content here..."></textarea>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Paste the raw content from ChatGPT, Claude, or any other AI model
                    </p>
                </div>

                <!-- Format Selection -->
                <div>
                    <label for="format" class="block text-sm font-medium text-gray-700">
                        Source Format
                    </label>
                    <select id="format" name="format" 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                        <option value="plaintext">Plain Text</option>
                        <option value="chatgpt">ChatGPT Format</option>
                        <option value="claude">Claude Format</option>
                        <option value="obsidian">Obsidian Format</option>
                    </select>
                </div>

                <!-- Processing Options -->
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="auto_structure" name="auto_structure" type="checkbox" checked
                                   class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="auto_structure" class="font-medium text-gray-700">Auto-structure content</label>
                            <p class="text-gray-500">Automatically add headings and format text</p>
                        </div>
                    </div>

                    <div class="flex items-start">
                        <div class="flex items-center h-5">
                            <input id="auto_metadata" name="auto_metadata" type="checkbox" checked
                                   class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="auto_metadata" class="font-medium text-gray-700">Auto-extract metadata</label>
                            <p class="text-gray-500">Automatically detect title, category, and tags</p>
                        </div>
                    </div>
                </div>

                <!-- Manual Metadata Override -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Metadata Override (Optional)</h3>
                    
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                            <input type="text" id="title" name="title" 
                                   class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                   placeholder="Leave empty for auto-detection">
                        </div>

                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="category" name="category"
                                   class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                   placeholder="Leave empty for auto-detection">
                        </div>

                        <div>
                            <label for="tags" class="block text-sm font-medium text-gray-700">Tags</label>
                            <input type="text" id="tags" name="tags"
                                   class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                   placeholder="Comma-separated tags">
                        </div>

                        <div>
                            <label for="author" class="block text-sm font-medium text-gray-700">Author</label>
                            <input type="text" id="author" name="author"
                                   class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                                   placeholder="Author name">
                        </div>
                    </div>
                </div>

                <!-- Obsidian Integration -->
                <div id="obsidian-options" class="border-t border-gray-200 pt-6 hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Obsidian Integration</h3>
                    
                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="convert_wikilinks" name="convert_wikilinks" type="checkbox" checked
                                       class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="convert_wikilinks" class="font-medium text-gray-700">Convert WikiLinks</label>
                                <p class="text-gray-500">Convert [[WikiLinks]] to standard markdown links</p>
                            </div>
                        </div>

                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="preserve_tags" name="preserve_tags" type="checkbox" checked
                                       class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="preserve_tags" class="font-medium text-gray-700">Preserve Obsidian tags</label>
                                <p class="text-gray-500">Keep #tags in the content</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="preview-btn"
                                class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Preview
                        </button>
                        <button type="button" id="import-btn"
                                class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Import Article
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Section -->
    <div id="preview-section" class="mt-8 hidden">
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">Preview</h2>
                
                <!-- Metadata Preview -->
                <div id="metadata-preview" class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Extracted Metadata</h3>
                    <div class="grid grid-cols-1 gap-2 sm:grid-cols-3 text-sm">
                        <div><strong>Title:</strong> <span id="preview-title">-</span></div>
                        <div><strong>Category:</strong> <span id="preview-category">-</span></div>
                        <div><strong>Tags:</strong> <span id="preview-tags">-</span></div>
                    </div>
                    <div class="mt-2 grid grid-cols-1 gap-2 sm:grid-cols-2 text-sm">
                        <div><strong>Word Count:</strong> <span id="preview-word-count">-</span></div>
                        <div><strong>Reading Time:</strong> <span id="preview-reading-time">-</span> min</div>
                    </div>
                </div>

                <!-- Quality Checks -->
                <div id="quality-checks" class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Quality Checks</h3>
                    <div id="quality-results" class="space-y-2 text-sm">
                        <!-- Quality check results will be populated here -->
                    </div>
                </div>

                <!-- Warnings -->
                <div id="warnings-section" class="mb-6 p-4 bg-yellow-50 rounded-lg hidden">
                    <h3 class="text-sm font-medium text-yellow-700 mb-2">Warnings</h3>
                    <ul id="warnings-list" class="list-disc list-inside text-sm text-yellow-700">
                        <!-- Warnings will be populated here -->
                    </ul>
                </div>

                <!-- Content Preview -->
                <div id="content-preview" class="prose max-w-none">
                    <!-- Processed content will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="success-message" class="mt-4 hidden">
        <div class="rounded-md bg-green-50 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-check-circle text-green-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-green-800" id="success-text"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="error-message" class="mt-4 hidden">
        <div class="rounded-md bg-red-50 p-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-red-800" id="error-text"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formatSelect = document.getElementById('format');
    const obsidianOptions = document.getElementById('obsidian-options');
    const previewBtn = document.getElementById('preview-btn');
    const importBtn = document.getElementById('import-btn');
    const previewSection = document.getElementById('preview-section');

    // Show/hide Obsidian options based on format selection
    formatSelect.addEventListener('change', function() {
        if (this.value === 'obsidian') {
            obsidianOptions.classList.remove('hidden');
        } else {
            obsidianOptions.classList.add('hidden');
        }
    });

    // Preview functionality
    previewBtn.addEventListener('click', async function() {
        await processContent(false);
    });

    // Import functionality
    importBtn.addEventListener('click', async function() {
        await processContent(true);
    });

    async function processContent(publish) {
        const formData = new FormData(document.getElementById('llm-import-form'));
        const content = formData.get('content');
        
        if (!content.trim()) {
            showError('Please enter some content to process');
            return;
        }

        // Prepare request data
        const requestData = {
            content: content,
            format: formData.get('format'),
            auto_structure: formData.has('auto_structure'),
            auto_metadata: formData.has('auto_metadata'),
            published: publish,
        };

        // Add optional fields
        if (formData.get('title')) requestData.title = formData.get('title');
        if (formData.get('category')) requestData.category = formData.get('category');
        if (formData.get('author')) requestData.author = formData.get('author');
        
        if (formData.get('tags')) {
            requestData.tags = formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag);
        }

        // Add Obsidian integration if format is obsidian
        if (formData.get('format') === 'obsidian') {
            requestData.obsidian_integration = {
                convert_wikilinks: formData.has('convert_wikilinks'),
                preserve_tags: formData.has('preserve_tags')
            };
        }

        // Show loading state
        const originalText = publish ? 'Import Article' : 'Preview';
        const button = publish ? importBtn : previewBtn;
        button.textContent = 'Processing...';
        button.disabled = true;

        try {
            const response = await fetch('/api/import/llm-article', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Failed to process content');
            }

            if (publish && result.success) {
                showSuccess(`Article "${result.post.title}" imported successfully!`);
                // Optionally redirect to the post
                if (result.post) {
                    setTimeout(() => {
                        window.location.href = `/admin/edit/${result.post.slug}`;
                    }, 2000);
                }
            } else if (result.preview) {
                showPreview(result);
            }

        } catch (error) {
            showError(error.message);
        } finally {
            button.textContent = originalText;
            button.disabled = false;
        }
    }

    function showPreview(result) {
        const preview = result.preview;
        const qualityChecks = result.quality_checks;
        const warnings = result.warnings;

        // Update metadata preview
        document.getElementById('preview-title').textContent = preview.extracted_title || 'Not detected';
        document.getElementById('preview-category').textContent = preview.extracted_category || 'Not detected';
        document.getElementById('preview-tags').textContent = preview.extracted_tags.join(', ') || 'None';
        document.getElementById('preview-word-count').textContent = preview.word_count;
        document.getElementById('preview-reading-time').textContent = preview.estimated_reading_time;

        // Update quality checks
        const qualityResults = document.getElementById('quality-results');
        qualityResults.innerHTML = '';
        
        if (qualityChecks) {
            const checks = [
                { label: 'Duplicate Check', status: !qualityChecks.duplicate_check.is_duplicate ? 'Pass' : 'Warning', color: !qualityChecks.duplicate_check.is_duplicate ? 'green' : 'yellow' },
                { label: 'Has Headings', status: qualityChecks.content_quality.has_headings ? 'Pass' : 'Needs Review', color: qualityChecks.content_quality.has_headings ? 'green' : 'yellow' },
                { label: 'Word Count', status: qualityChecks.content_quality.word_count > 100 ? 'Good' : 'Short', color: qualityChecks.content_quality.word_count > 100 ? 'green' : 'yellow' },
                { label: 'Metadata Completeness', status: Math.round(qualityChecks.metadata_completeness.completeness_score * 100) + '%', color: qualityChecks.metadata_completeness.completeness_score > 0.6 ? 'green' : 'yellow' }
            ];

            checks.forEach(check => {
                const div = document.createElement('div');
                div.className = 'flex justify-between';
                div.innerHTML = `
                    <span>${check.label}:</span>
                    <span class="font-medium text-${check.color}-600">${check.status}</span>
                `;
                qualityResults.appendChild(div);
            });
        }

        // Show warnings if any
        if (warnings && warnings.length > 0) {
            const warningsSection = document.getElementById('warnings-section');
            const warningsList = document.getElementById('warnings-list');
            warningsList.innerHTML = '';
            
            warnings.forEach(warning => {
                const li = document.createElement('li');
                li.textContent = warning;
                warningsList.appendChild(li);
            });
            
            warningsSection.classList.remove('hidden');
        } else {
            document.getElementById('warnings-section').classList.add('hidden');
        }

        // Show structured content preview (simplified - just show as formatted text)
        document.getElementById('content-preview').innerHTML = 
            '<pre class="whitespace-pre-wrap text-sm">' + 
            escapeHtml(preview.structured_content) + 
            '</pre>';

        // Show preview section
        previewSection.classList.remove('hidden');
        previewSection.scrollIntoView({ behavior: 'smooth' });
    }

    function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        successText.textContent = message;
        successDiv.classList.remove('hidden');
        
        // Hide after 5 seconds
        setTimeout(() => {
            successDiv.classList.add('hidden');
        }, 5000);
    }

    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');
        
        // Hide after 10 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 10000);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
});
</script>
{% endblock %}